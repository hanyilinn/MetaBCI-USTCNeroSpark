# åŸºäºŽè„‘ç”µä¿¡å·çš„çŸ­è§†é¢‘å–œå¥½åº¦è¯„ä¼°ç³»ç»Ÿ

#### USTC-NeroSparkå›¢é˜Ÿ

## æ¦‚è¦

æœ¬ç³»ç»Ÿä¸»è¦ç”±**3ä¸ªæ¨¡å—**ç»„æˆï¼š

1ï¼‰è§†é¢‘åˆºæ¿€è¯±å‘æ¨¡å—

2ï¼‰ç¦»çº¿è®­ç»ƒæ¨¡å—

3ï¼‰åœ¨çº¿æµ‹è¯•æ¨¡å—

æœ¬æ–‡æ¡£å°†åˆ†åˆ«äºˆä»¥è¯¦ç»†ä»‹ç»ã€‚

### ä¸€ã€å®žéªŒè®¾å¤‡ä¸Žå®žéªŒè®¾ç½®

æœ¬ç ”ç©¶ä½¿ç”¨æ¶ˆè´¹çº§Museå¤´çŽ¯é‡‡é›†å‚ä¸Žè€…çš„EEGæ•°æ®ã€‚Museå¤´çŽ¯å…·å¤‡4ä¸ªEEGé€šé“ï¼Œæ ¹æ®å›½é™…10-20ç³»ç»Ÿï¼Œè¿™äº›é€šé“åˆ†åˆ«å¯¹åº”äºŽé¢å¶AF7å’ŒAF8ä»¥åŠé¢žå¶TP9å’ŒTP10,å‰é¢ä¸­å¿ƒFpzä½œä¸ºå‚è€ƒä¿¡å·ã€‚æ‰€æœ‰ç”µæžå‡ä¸ºå¹²å¼ç”µæžï¼Œæ–¹ä¾¿ç”¨æˆ·ä½©æˆ´ã€‚è„‘ç”µä¿¡å·é‡‡æ ·çŽ‡ä¸º256Hzã€‚è€ƒè™‘åˆ°ä¿¡å·é‡‡é›†è´¨é‡ï¼Œæœ¬ç ”ç©¶åªä½¿ç”¨AF7å’ŒAF8ä¸¤ä¸ªé€šé“è¿›è¡ŒåŽç»­å¤„ç†ä¸Žåˆ†æžï¼Œé‡‡é›†åˆ°çš„EEGä¿¡å·é€šè¿‡è“ç‰™ä¼ è¾“åˆ°è®¡ç®—æœºè®¾å¤‡ã€‚

å—è¯•è€…ä¸ºä¸€å23å²æˆå¹´ç”·æ€§ï¼Œå…±è¿›è¡Œ4æ¬¡å®žéªŒï¼Œæ¯æ¬¡å®žéªŒæ—¶é—´æŽ§åˆ¶åœ¨45åˆ†é’Ÿå·¦å³ã€‚å—è¯•è€…æŒæœ‰æœ¬ç§‘å­¦ä½ï¼Œå…·å¤‡æ­£å¸¸çš„è£¸çœ¼è§†åŠ›ï¼Œä¸”æ— ç¥žç»æˆ–ç²¾ç¥žç–¾ç—…ä»¥åŠå¤´éƒ¨åˆ›ä¼¤å²ï¼Œä¸ºå³æ‰‹ä½¿ç”¨ä¹ æƒ¯è€…ã€‚å®žéªŒå‰ï¼Œå·²è¢«å……åˆ†å‘ŠçŸ¥å®žéªŒç›®çš„ï¼Œå®Œå…¨äº†è§£å®žéªŒç¨‹åºï¼Œå¹¶å·²ç­¾ç½²çŸ¥æƒ…åŒæ„ä¹¦ã€‚

å®žéªŒæ‰€éœ€è§†é¢‘æ¥æºäºŽæŠ–éŸ³è½¯ä»¶ï¼Œå…±é‡‡é›†135ä¸ªæ—¶é•¿åœ¨30ç§’å·¦å³çš„çŸ­è§†é¢‘ï¼Œä¸ºå‡å°‘è½¯ä»¶æŽ¨èç®—æ³•äº§ç”Ÿçš„å½±å“ï¼Œ135ä¸ªçŸ­è§†é¢‘åˆ†åˆ«ç”±5ä¸ªè´¦å·æ”¶é›†å®Œæˆï¼Œæ¯æ¬¡å®žéªŒå°†éšæœºæ’­æ”¾æœªæ’­æ”¾çš„è§†é¢‘ã€‚

### äºŒã€è§†é¢‘åˆºæ¿€è¯±å‘æ¨¡å—

ä¸ŽMeta BCIå·²æä¾›çš„P300ã€SSVEPç­‰åŠŸèƒ½ç±»ä¼¼ï¼Œæˆ‘ä»¬å¼€å‘çš„è§†é¢‘åˆºæ¿€è¯±å‘æ¨¡å—å°è£…åœ¨ `brainstim`æ–‡ä»¶å¤¹ä¸­ `paradigm.py`çš„ `mp4play`å—ï¼Œå¹¶åœ¨ `stim_demo.py`ä¸­è¿›è¡Œè°ƒç”¨ã€‚

#### mp4playï¼šç»§æ‰¿è‡ª `VisualStim`ï¼Œæä¾›ä¸“ç”¨äºŽå¤„ç†MP4è§†é¢‘æ’­æ”¾å’Œç”¨æˆ·åé¦ˆçš„ç±»ã€‚

```python
def __init__(self, win, colorSpace="rgb", allowGUI=True):
```

- **å‚æ•°**:
  - `win`: è§†é¢‘å°†æ’­æ”¾çš„çª—å£ã€‚
  - `colorSpace` (str): è§†é¢‘çš„é¢œè‰²ç©ºé—´ï¼Œé»˜è®¤ä¸º"rgb"ã€‚
  - `allowGUI` (bool): æ˜¯å¦å…è®¸ä½¿ç”¨GUIç»„ä»¶ï¼Œé»˜è®¤ä¸ºTrueã€‚
- **è¯´æ˜Ž**: åˆå§‹åŒ– `mp4play`å®žä¾‹ï¼Œè®¾ç½®è§†é¢‘æ–‡ä»¶å¤¹è·¯å¾„å¹¶åŠ è½½å¯ç”¨çš„MP4æ–‡ä»¶ã€‚

##### 1.mp4gain

```python
def mp4gain(self):
```

- **è¯´æ˜Ž**: éšæœºé€‰æ‹©ä¸€ä¸ªå°šæœªæ’­æ”¾çš„MP4è§†é¢‘æ–‡ä»¶å¹¶è¿”å›žå…¶è·¯å¾„ã€‚å¦‚æžœæ‰€æœ‰è§†é¢‘éƒ½å·²æ’­æ”¾ï¼Œåˆ™é€šçŸ¥ç”¨æˆ·ã€‚

##### 2.feedback

```python
def feedback(self, video_path):
```

- **å‚æ•°**:
  - `video_path` (str): è¦æ’­æ”¾çš„è§†é¢‘çš„æ–‡ä»¶è·¯å¾„ã€‚
- **è¯´æ˜Ž**: ä½¿ç”¨VLCæ’­æ”¾è§†é¢‘ï¼Œå¹¶å¤„ç†ç”¨æˆ·åé¦ˆè¿›è¡Œè¯„åˆ†ã€‚å°†åˆ†æ•°ä¿å­˜åˆ°æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚

##### 3.get_scores

```python
def get_scores(self):
```

- **è¿”å›ž**: åŒ…å«ç”¨æˆ·å¯¹"å–œå¥½åº¦"ã€"æƒ…æ„Ÿä»·å€¼"å’Œ"å”¤é†’åº¦"çš„è¯„åˆ†çš„å­—å…¸ã€‚
- **è¯´æ˜Ž**: åˆ›å»ºä¸€ä¸ªGUIçª—å£ä¾›ç”¨æˆ·ä½¿ç”¨æ»‘å—è¾“å…¥è¯„åˆ†ã€‚åŠ¨æ€æ›´æ–°æ ‡ç­¾å¹¶è¿”å›žå­—å…¸å½¢å¼çš„è¯„åˆ†ã€‚

##### 4.format_scale

```python
def format_scale(self, var, value, position, label):
```

- **å‚æ•°**:
  - `var`: ä¸Žæ»‘å—å…³è”çš„tkinterå˜é‡ã€‚
  - `value`: æ»‘å—çš„å½“å‰å€¼ã€‚
  - `position`: æ»‘å—çš„ä½ç½®ã€‚
  - `label`: æ»‘å—çš„æ ‡ç­¾ã€‚
- **è¯´æ˜Ž**: å°†æ»‘å—å€¼å››èˆäº”å…¥åˆ°æœ€è¿‘çš„æ•´æ•°ã€‚

##### 5.save_scores

```python
def save_scores(self, video_path, start_time, end_time, scores):
```

- **å‚æ•°**:
  - `video_path` (str): æ’­æ”¾è§†é¢‘çš„è·¯å¾„ã€‚
  - `start_time` (datetime): è§†é¢‘å¼€å§‹æ’­æ”¾çš„æ—¶é—´ã€‚
  - `end_time` (datetime): è§†é¢‘ç»“æŸçš„æ—¶é—´ã€‚
  - `scores` (dict): `get_scores`è¿”å›žçš„è¯„åˆ†å­—å…¸ã€‚
- **è¯´æ˜Ž**: å°†è§†é¢‘æ’­æ”¾ä¿¡æ¯å’Œç”¨æˆ·è¯„åˆ†ä¿å­˜åˆ°åä¸º'scores.txt'çš„æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚

#### stim_demoä¸­çš„è°ƒç”¨

é€‰æ‹©ç•Œé¢ã€åˆå§‹åŒ–ç•Œé¢ä¸Ž `stim_demo.py`ä¸­å…¶ä»–èŒƒå¼ä¿æŒä¸€è‡´

```python
player = mp4play(win=win)
    bg_color = np.array([0.3, 0.3, 0.3])  # èƒŒæ™¯é¢œè‰²
    display_time = 1  # èŒƒå¼å¼€å§‹1sçš„warmæ—¶é•¿
    index_time = 1  # æç¤ºæ—¶é•¿ï¼Œè½¬ç§»è§†çº¿
    rest_time = 0.5  # æç¤ºåŽçš„ä¼‘æ¯æ—¶é•¿
    response_time = 1  # åœ¨çº¿åé¦ˆ
    port_addr = "COM8"  #  0xdefc                                  # é‡‡é›†ä¸»æœºç«¯å£
    port_addr = None  #  0xdefc
    nrep = 2  # blockæ•°ç›®
    lsl_source_id = "meta_online_worker"  # None                 # source id
    online = False  # True                                       # åœ¨çº¿å®žéªŒçš„æ ‡å¿—
    ex.register_paradigm(
        "mp4play",
        paradigm,
        VSObject=player,
        bg_color=bg_color,
        display_time=display_time,
        index_time=index_time,
        rest_time=rest_time,
        response_time=response_time,
        port_addr=port_addr,
        nrep=nrep,
        pdim="mp4play",
        lsl_source_id=lsl_source_id,
        online=online,
    )
    while True:
        video_path = player.mp4gain()
        if video_path:
            player.feedback(video_path)
        else:
            break
    ex.run()
```

è¿è¡Œstim_demo.pyåŽå°†è¿›å…¥è§†é¢‘æ’­æ”¾ç•Œé¢ï¼š
![image-20240802213231361](https://github.com/hanyilinn/MetaBCI-USTCNeroSpark/blob/master/images/image-20240802213231361.png)

è§†é¢‘æ’­æ”¾ç»“æŸåŽå¼¹å‡ºæ‰“åˆ†æ¡†ï¼Œæˆ‘ä»¬é€‰ç”¨äº†è„‘ç”µæƒ…ç»ªè¯†åˆ«ä»»åŠ¡å¸¸ç”¨çš„3ä¸ªæŒ‡æ ‡ï¼š`liking`è¡¨ç¤ºå¯¹çŸ­è§†é¢‘çš„å–œå¥½åº¦ï¼Œ`valence`è¡¨ç¤ºè¯¥çŸ­è§†é¢‘çš„å¼€å¿ƒç¨‹åº¦ï¼Œ`arousal`è¡¨ç¤ºè¯¥çŸ­è§†é¢‘çš„å…´å¥‹ç¨‹åº¦ï¼Œæ¯ä¸ªæŒ‡æ ‡æ»¡åˆ†10åˆ†ï¼Œæœ€ä½Žåˆ†0åˆ†ã€‚

![image-20240802213553007](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240802213553007.png)

ç‚¹å‡»æäº¤åŽè¿›å…¥ä¸‹ä¸€ä¸ªè§†é¢‘çš„æ’­æ”¾ï¼Œè‹¥ç‚¹å‡»å…³é—­åˆ™ç»“æŸå®žéªŒã€‚

æ‰“åˆ†çš„ç»“æžœå°†å­˜å‚¨äºŽ `scores.txt`æ–‡ä»¶ä¸­ï¼Œç”¨äºŽåŽç»­ç¦»çº¿æ¨¡å—è®­ç»ƒï¼Œå­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š

```python
Play Video Path: D:\MetaBCI-master\tiktok\ï¿½ï¿½ï¿½ï¿½2024720-197607.mp4
Starting time: 2024-07-26 17:46:48.469274
Ending time: 2024-07-26 17:47:14.480259
Liking: 5.0
Valence: 5.0
Arousen: 5.0
----------------------------------------
```

å…¶ä¸­ï¼Œ`Play Video Path`è¡¨ç¤ºæ’­æ”¾çš„è§†é¢‘è·¯å¾„ï¼Œ`Starting time`è¡¨ç¤ºè§†é¢‘å¼€å§‹æ’­æ”¾çš„æ—¶é—´ï¼Œ`Ending time`è¡¨ç¤ºè§†é¢‘ç»“æŸæ’­æ”¾çš„æ—¶é—´ï¼Œ`Liking` ,`Valence`, `Arousen`åˆ†åˆ«è®°å½•çš„æ˜¯å—è¯•è€…çš„æ‰“åˆ†ç»“æžœã€‚

åœ¨æ’­æ”¾è§†é¢‘è¯±å¯¼åˆºæ¿€çš„åŒæ—¶ï¼ŒMuseé‡‡é›†è®¾å¤‡ä¹Ÿåœ¨å®žæ—¶é‡‡é›†æ•°æ®ï¼š

![image-20240802215557908](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240802215557908.png)

### ä¸‰ã€ç¦»çº¿è®­ç»ƒæ¨¡å—

ç¦»çº¿è®­ç»ƒæ¨¡å—ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š

1ï¼‰æ•°æ®é›†å¤„ç†ï¼šå¯¹äºŽæ¯ä¸ªè§†é¢‘ï¼Œä»Žæ•´æ®µè„‘ç”µæ•°æ®ä¸­æˆªå–å‡ºè¯¥è§†é¢‘çš„æ’­æ”¾å¼€å§‹æ—¶é—´ä¸Žç»“æŸæ—¶é—´ä¹‹é—´çš„è„‘ç”µæ•°æ®ï¼Œè¿›è¡Œæ»¤æ³¢å¤„ç†åŽé€šè¿‡è®¾å®šçš„æ­¥é•¿å’Œé•¿åº¦æˆªå–æˆè‹¥å¹²ç‰‡æ®µä½œä¸ºæ•°æ®é›†ã€‚å—è¯•è€…çš„æ‰“åˆ†ç»“æžœä¸ºæ•°æ®é›†æ ‡ç­¾ã€‚

2ï¼‰æ¨¡åž‹çš„è®­ç»ƒï¼šä¸ºå®žçŽ°å®žæ—¶å¤„ç†çš„ä½Žå»¶æ—¶æ€§ï¼Œæˆ‘ä»¬é€‰æ‹©åŸºç¡€çš„å¤šå°ºåº¦æ·±åº¦å·ç§¯æ¨¡åž‹ã€‚

#### æ•°æ®é›†å¤„ç†

##### 1.butter_bandpass

åˆ›å»ºå·´ç‰¹æ²ƒæ–¯å¸¦é€šæ»¤æ³¢å™¨çš„ç³»æ•°ã€‚

```python
def butter_bandpass(lowcut, highcut, fs, order=5):
```

- **å‚æ•°**:
  - `lowcut`: ä½Žæˆªæ­¢é¢‘çŽ‡ã€‚
  - `highcut`: é«˜æˆªæ­¢é¢‘çŽ‡ã€‚
  - `fs`: é‡‡æ ·é¢‘çŽ‡ã€‚
  - `order`: æ»¤æ³¢å™¨çš„é˜¶æ•°ï¼Œé»˜è®¤ä¸º5ã€‚
- **è¿”å›ž**: æ»¤æ³¢å™¨çš„ç³»æ•° `b` å’Œ `a`ã€‚

##### 2. butter_bandpass_filter

å¯¹æ•°æ®åº”ç”¨å·´ç‰¹æ²ƒæ–¯å¸¦é€šæ»¤æ³¢å™¨ã€‚

```python
def butter_bandpass_filter(data, lowcut, highcut, fs, order=5):
```

- **å‚æ•°**:
  - `data`: è¦æ»¤æ³¢çš„æ•°æ®ã€‚
  - `lowcut`, `highcut`, `fs`, `order`: ä¸Ž `butter_bandpass`ç›¸åŒã€‚
- **è¿”å›ž**: æ»¤æ³¢åŽçš„æ•°æ®ã€‚

##### 3. ReadCntFile

ä»ŽCNTæ–‡ä»¶ä¸­è¯»å–EEGæ•°æ®ã€‚

```python
def ReadCntFile(cntFileName="EEG.cnt"):
```

- **å‚æ•°**:
  - `cntFileName`: CNTæ–‡ä»¶çš„åç§°ï¼Œé»˜è®¤ä¸º"EEG.cnt"ã€‚
- **è¿”å›ž**: åŒ…å«EEGæ•°æ®çš„NumPyæ•°ç»„ã€‚

##### 4. ReadCntFile_ly

è¯»å–CNTæ–‡ä»¶å¹¶æ ¹æ®éœ€è¦è§£ç ç‰¹å®šæ•°é‡çš„é€šé“ã€‚

```python
def ReadCntFile_ly(cntFileName="EEG.cnt", numProcessSample=2048, isLatestSample=True, file_type='EEG'):
```

- **å‚æ•°**:
  - `cntFileName`: CNTæ–‡ä»¶çš„åç§°ã€‚
  - `numProcessSample`: è¦å¤„ç†çš„æ ·æœ¬æ•°ã€‚
  - `isLatestSample`: æ˜¯å¦åªè¯»å–æœ€æ–°çš„æ ·æœ¬ã€‚
  - `file_type`: æ•°æ®ç±»åž‹ï¼Œ'EEG' æˆ– 'PPG'ã€‚
- **è¿”å›ž**: åŒ…å«EEGæˆ–PPGæ•°æ®çš„NumPyæ•°ç»„ã€‚

##### 5. convert_to_timestamp

å°†æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´æˆ³ã€‚Museå¤´çŽ¯é»˜è®¤ä½¿ç”¨æ—¶é—´æˆ³æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œæ•…éœ€è¦å°†scores.txtä¸­ä¿å­˜çš„è§†é¢‘å¼€å§‹ä¸Žç»“æŸæ—¶é—´è½¬æ¢ä¸ºæ—¶é—´æˆ³æ ¼å¼ã€‚

```python
def convert_to_timestamp(time_str):
```

- **å‚æ•°**:
  - `time_str`: æ—¶é—´å­—ç¬¦ä¸²ã€‚
- **è¿”å›ž**: è½¬æ¢åŽçš„æ—¶é—´æˆ³ã€‚

##### 6. parse_txt_file

è§£æžscores.txtæ–‡ä»¶å¹¶æå–æ•°æ®ã€‚

```python
def parse_txt_file(file_path):
    stats = []
    with open(file_path, 'r', encoding='gbk') as file:
        lines = file.readlines()
        segment_start_idx = 0  # ç‰‡æ®µèµ·å§‹ç´¢å¼•

        # æŒ‰ç‰‡æ®µè¯»å–ï¼Œæ¯ä¸ªç‰‡æ®µæœ‰6è¡Œæ•°æ®
        for i in range(0, len(lines), 7):  # æ­¥é•¿ä¸º7ï¼Œç¡®ä¿æ¯æ¬¡å¤„ç†7è¡Œ
            try:
                # è¯»å–æ¯ä¸ªç‰‡æ®µçš„ç¬¬äºŒè¡Œå’Œç¬¬ä¸‰è¡Œ
                stat_time_str = lines[i + 1].strip()
                end_time_str = lines[i + 2].strip()

                # è½¬æ¢ä¸ºæ—¶é—´æˆ³
                stat_timestamp = convert_to_timestamp(stat_time_str)
                end_timestamp = convert_to_timestamp(end_time_str)

                # è¯»å–liking, valence, arousençš„å€¼
                liking_str = lines[i + 3].split(': ')[1].replace("\n", "")
                valence_str = lines[i + 4].split(': ')[1].replace("\n", "")
                arousen_str = lines[i + 5].split(': ')[1].replace("\n", "")

                liking = np.int64(float(liking_str))
                valence = np.int64(float(valence_str))
                arousen = np.int64(float(arousen_str))

                # å­˜å‚¨ç»“æžœ
                stats.append({
                    'start_time': stat_timestamp,
                    'end_time': end_timestamp,
                    'liking': liking,
                    'valence': valence,
                    'arousen': arousen
                })
            except IndexError:
                # å¦‚æžœç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œåœæ­¢è¯»å–
                break
            except ValueError:
                # å¦‚æžœè½¬æ¢æ•°å€¼å¤±è´¥ï¼Œæ‰“å°é”™è¯¯å¹¶ç»§ç»­
                print(f"Error converting values to float at line {i + 3} to {i + 5}")
```

- **å‚æ•°**:
  - `file_path`: scores.txtæ–‡ä»¶çš„è·¯å¾„ã€‚
- **è¿”å›ž**: åŒ…å«è§£æžæ•°æ®çš„åˆ—è¡¨ã€‚

#### ä¸»å‡½æ•°çš„ä½¿ç”¨

```python
    step = 128 #æ•°æ®é›†åˆ’åˆ†æ­¥é•¿
    window_length = 256 #æ•°æ®é›†åˆ’åˆ†é•¿åº¦
    data_for_exper = []
    datapath = [1722078786118,1722497227125,1722510612662,1722592557872] #4æ¬¡å®žéªŒ
    i = 2
    for data_path in datapath:
        data = ReadCntFile('C:\CBCR\MuseData\\'+str(data_path)+'\EEG.cnt')
        data[:, 5] = data[:, 5].astype(np.int64)
        data_label = parse_txt_file('D:\MetaBCI-master\scores'+str(i)+'.txt')
        for label in data_label:
            if label['valence'] in [0,1,2,3]:
                flag = 0
            elif label['valence'] in [6,7,8,9]:
                flag = 1
            else:
                break
            # æ ¹æ® start_time å’Œ end_time æˆªå– data ä¸­çš„æ—¶é—´æˆ³å¯¹åº”çš„æ•°æ®
            print('è§†é¢‘å¼€å§‹æ—¶é—´ä¸ºï¼š',label['start_time'])
            print('è§†é¢‘ç»“æŸæ—¶é—´ä¸ºï¼š',label['end_time'])
            start_idx = np.searchsorted(data[:, 5], label['start_time'], side='left')
            end_idx = np.searchsorted(data[:, 5], label['end_time'], side='right')
            # æˆªå– data ä¸­çš„æ—¶é—´æˆ³ä¸º start_time å’Œ end_time ä¹‹é—´çš„æ•°æ®
            selected_data = data[start_idx:end_idx, 1:3].T
            EEG = butter_bandpass_filter(selected_data, 0.3, 45, 256, order=6)
            for start in range(0, EEG.shape[1] - window_length + 1, step):
                window = EEG[:, start:start + window_length]
              
                data_for_exper.append((window, flag))  # å‡è®¾æ ‡ç­¾ 'a' å¯¹åº”äºŽæ‰€æœ‰çª—å£
        i += 1
```

#### æ¨¡åž‹çš„åˆå§‹åŒ–ä¸Žè®­ç»ƒ

æˆ‘ä»¬ä½¿ç”¨å¤šå°ºåº¦å·ç§¯ç½‘ç»œRACNN-Liteä½œä¸ºæ¨¡åž‹ã€‚åˆ’åˆ†æ•°æ®é›†çš„å‰80%ä¸ºè®­ç»ƒé›†ï¼ŒåŽ20%ä¸ºæµ‹è¯•é›†ã€‚Batch sizeè®¾ç½®ä¸º64ï¼Œepochè®¾ç½®ä¸º50ï¼Œå­¦ä¹ çŽ‡è®¾ç½®ä¸º0.0001ï¼Œè¾å­¦çŽ‡è®¾ç½®ä¸º0.5ã€‚

![image-20240803153330091](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240803153330091.png)

RACNN-LiteåŒ…å«æ—¶é—´ç‰¹å¾æå–å™¨ã€åŒºåŸŸç‰¹å¾æå–å™¨ã€éžå¯¹ç§°ç‰¹å¾æå–å™¨ä»¥åŠåˆ†ç±»å™¨ã€‚

æ—¶é—´ç‰¹å¾æå–å™¨ç”±ä¸‰ä¸ªåœ¨æ—¶é—´ç»´åº¦ä¸Šå¹¶è¡Œçš„ä¸åŒå°ºå¯¸çš„ä¸€ç»´å·ç§¯å±‚ç»„æˆï¼Œç”¨äºŽå­¦ä¹ å¤šå°ºåº¦æ—¶é—´ç‰¹å¾ã€‚å·ç§¯æ ¸çš„å¤§å°åˆ†åˆ«ä¸ºð‘“ð‘ /2ã€ð‘“ð‘ /4ã€ð‘“ð‘ /8ï¼Œå…¶ä¸­ð‘“ð‘ ä¸ºé‡‡æ ·çŽ‡ã€‚å°†ä¸‰ä¸ªæ—¶é—´ç‰¹å¾æ‹¼æŽ¥å¹¶åŒæ­¥è¾“å…¥åˆ°åŒºåŸŸç‰¹å¾æå–å™¨å’Œéžå¯¹ç§°ç‰¹å¾æå–å™¨ã€‚åŒºåŸŸç‰¹å¾æå–å™¨ä¸ºä¸€ä¸ªé€šé“ç»´åº¦çš„ä¸€ç»´å·ç§¯å±‚ï¼Œç”¨äºŽå­¦ä¹ åŒºåŸŸç‰¹å¾ã€‚å·ç§¯æ ¸å¤§å°ä¸º2ï¼Œä¸Žè¾“å…¥é€šé“æ•°ç›¸åŒã€‚éžå¯¹ç§°ç‰¹å¾æå–å™¨ä¸ºä¸€ä¸ªADLå±‚ï¼Œç”¨äºŽå­¦ä¹ å‰é¢å¶ä¸¤é€šé“AF7å’ŒAF8çš„ä¸å¯¹ç§°ç‰¹å¾ã€‚å°†åŒºåŸŸç‰¹å¾å’Œä¸å¯¹ç§°ç‰¹å¾æ‹¼æŽ¥åŽè¾“å…¥åˆ°ç”±ä¸¤ä¸ªå…¨è¿žæŽ¥å±‚ç»„æˆçš„åˆ†ç±»å™¨è¿›è¡Œæƒ…ç»ªåˆ†ç±»ã€‚æ‰€æœ‰å·ç§¯å±‚çš„é€šé“æ•°å‡ä¸º16ï¼Œä¸¤ä¸ªå…¨è¿žæŽ¥å±‚çš„ç¥žç»å…ƒä¸ªæ•°åˆ†åˆ«ä¸º32å’Œ2ã€‚

é€šè¿‡ç¦»çº¿æ¨¡åž‹è®­ç»ƒå¾—åˆ°ä¸ªä½“æ¨¡åž‹ï¼Œå®žçŽ°å¯¹é«˜/ä½Žarousalçš„äºŒåˆ†ç±»ã€‚åœ¨åœ¨çº¿åº”ç”¨é˜¶æ®µï¼Œæ¨¡åž‹è¾“å‡ºçš„0-1ä¹‹é—´çš„æ¦‚çŽ‡é¢„æµ‹è¢«çº¿æ€§æ˜ å°„ä¸º0-100ä¹‹é—´çš„arousalæŒ‡æ•°ï¼Œç”¨äºŽåœ¨çº¿åé¦ˆæƒ…ç»ªåˆ†æ•°ã€‚

### å››ã€åœ¨çº¿æµ‹è¯•æ¨¡å—

åœ¨çº¿æµ‹è¯•æ¨¡å—ä¸»è¦ç›®æ ‡æ˜¯è¯»å–è„‘ç”µé‡‡é›†è®¾å¤‡å®žæ—¶å†™å…¥çš„æ•°æ®å¹¶è¾“å…¥æ¨¡åž‹å¹¶è¾“å‡ºç»“æžœã€‚å…·ä½“å®žçŽ°ä½äºŽ `Online_Video.py`ä¸­ã€‚

#### ReadCntFile_ly

æ ¹æ® `file_type`ç¡®å®šè¦è§£ç çš„é€šé“æ•°ã€‚ä½¿ç”¨äºŒè¿›åˆ¶è¯»å–æ¨¡å¼æ‰“å¼€CNTæ–‡ä»¶ï¼Œå¹¶è¯»å–æ–‡ä»¶å¤´ä¿¡æ¯ï¼ŒåŒ…æ‹¬é€šé“æ•°ã€æ¯æ ·æœ¬äº‹ä»¶æ•°ã€é‡‡æ ·çŽ‡ç­‰ã€‚å¦‚æžœ `isLatestSample`ä¸ºTrueï¼Œå‡½æ•°å°†å°è¯•è¯»å–æ–‡ä»¶æœ«å°¾çš„æœ€æ–°æ ·æœ¬æ•°æ®ã€‚è¯»å–çš„æ•°æ®è¢«è½¬æ¢ä¸ºNumPyæ•°ç»„å¹¶è¿”å›žã€‚Museå¤´çŽ¯é‡‡é›†çš„æ•°æ®å®žæ—¶å†™å…¥ `/streaming/EEG.net`æ–‡ä»¶ä¸­ï¼Œå› æ­¤ `ReadCntFile_ly`åœ¨åœ¨çº¿æµ‹è¯•å®žéªŒæ—¶å®žæ—¶è¯»å–è¯¥æ–‡ä»¶ä¸­æœ€åŽè‹¥å¹²è¡Œçš„æ•°æ®ä»¥è¾¾æˆå®žæ—¶å¤„ç†çš„è¦æ±‚ã€‚

```python
def ReadCntFile_ly(cntFileName="EEG.cnt", numProcessSample=2048, isLatestSample=True, file_type='EEG'):
```

- **å‚æ•°**:
  - `cntFileName`: è¦è¯»å–çš„CNTæ–‡ä»¶åï¼Œé»˜è®¤ä¸º"EEG.cnt"ã€‚
  - `numProcessSample`: è¦å¤„ç†çš„æ ·æœ¬æ•°é‡ï¼Œé»˜è®¤ä¸º2048ã€‚
  - `isLatestSample`: æ˜¯å¦åªè¯»å–æœ€æ–°çš„æ ·æœ¬ï¼Œé»˜è®¤ä¸ºTrueã€‚
  - `file_type`: æ•°æ®ç±»åž‹ï¼Œå¯ä»¥æ˜¯'EEG'æˆ–'PPG'ï¼Œé»˜è®¤ä¸º'EEG'ã€‚
- **è¿”å›ž**: å¤„ç†åŽçš„æ•°æ®æ•°ç»„ã€‚

#### ä¸»å‡½æ•°

æœ€åŽçš„è¾“å‡ºå³ä¸ºé¢„æµ‹çš„likingå€¼ï¼Œè½¬æ¢ä¸ºç™¾åˆ†åˆ¶å½¢å¼ã€‚

```python
    #åŠ è½½æ¨¡åž‹
    model = TSception(num_classes=2, input_size=(1,2,256), sampling_rate=256, num_T=15, num_S=15,hidden=32, dropout_rate=0.5)
    model_path = 'D:\MetaBCI-master\demos\\brainflow_demos\\49model.pth'
    model.load_state_dict(torch.load(model_path))
    model.eval()
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    model.to(device)
    print('å·²æˆåŠŸåŠ è½½æ¨¡åž‹')
    #ä¸»å¾ªçŽ¯
    while 1>0:
        try:
            data = ReadCntFile_ly('C:\CBCR\MuseData\Streaming\EEG.cnt', numProcessSample=num)
            if data.shape[0]>=num:
                EEG = data[-256:,1:3].transpose()
                EEG = butter_bandpass_filter(EEG, 0.3, 45, 256, order=6)
                EEG = torch.from_numpy(EEG, ).to(torch.float32).to(device)
                EEG = EEG.unsqueeze(0)
                output = model(EEG)
                probabilities = torch.sigmoid(output)
                value = probabilities[0][1].item().float()
                print("é¢„æµ‹çš„likingå€¼æ˜¯",value*100,"%")
                time.sleep(0.1)
        except:
            pass
```

å¦‚ä¸‹ä¸ºä¸€å…¸åž‹çš„ç¤ºä¾‹ç»“æžœï¼š
![image-20240803154427150](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240803154427150.png)
